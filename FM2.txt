#!/bin/bash

# Ask user for job name
read -p "Enter job name (e.g., sj_POST_SI): " JOB_NAME

# Temporary files
TEMP_FILE=$(mktemp)
FAILED_JOBS="failed_jobs.txt"

# Function to get job and its dependencies
get_dependencies() {
    job=$1
    echo "$job" >> "$TEMP_FILE"
    # Extract job dependencies using autorep
    autorep -q -J "$job" | grep -i 'Condition' |
    grep -o '[a-zA-Z0-9_\.]\+' | grep -v 'success' | grep -v 'failure' >> "$TEMP_FILE"
}

# Collect job and its dependencies
> "$TEMP_FILE"
get_dependencies "$JOB_NAME"

# Remove duplicates
sort -u "$TEMP_FILE" -o "$TEMP_FILE"

# Check statuses
> "$FAILED_JOBS"
while read -r job; do
    STATUS=$(autostatus -j "$job")

    if [[ "$STATUS" != "SU" ]]; then
        if [[ "$STATUS" == "INACTIVE" ]]; then
            echo "$job : INACTIVE (Job not enabled or scheduled)" >> "$FAILED_JOBS"
        else
            echo "$job : $STATUS" >> "$FAILED_JOBS"
        fi
    fi
done < "$TEMP_FILE"

# Final output
if [[ -s "$FAILED_JOBS" ]]; then
    echo "Some jobs did not run successfully or are inactive."
    echo "Check the report: $FAILED_JOBS"
else
    echo "All jobs and dependent jobs ran successfully in AutoSys."
    rm "$FAILED_JOBS"
fi

# Cleanup
rm "$TEMP_FILE"
