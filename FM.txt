export DD_MFLAGS=$data/file/MFLAGS
echo "Deleting old prt files"
rm -f $spool/depdsrh1*
echo "Deletion done.....proceding for today's run."
pgm=`basename $0`
program=UTSRH1
run_mode=' -s'
jobname=depdsrh1
summary_file=UTSRH1.summary.1.out
export summary_file=$summary_file
export MULTISTREAM_UTSRH1="N"
# Refresh Summary file
echo > $sysout/$summary_file
if [ ! -s $card/UTSRH1MS.card   ];then
   if [ "$AUTOSYS_MODE" = "Y" ]; then
      echo "CANNOT FIND MULTI STREAM CARD ... ABORTING PROCESSING." >> $sysout/zerobyte.log
   else
      echo "ATTENTION ! CANNOT FIND MULTI STREAM CARD ..."
   fi
   exit 1
fi
mscard=$card/UTSRH1MS.card
ms_flag=`grep '       SPEC$STREAM' $mscard|awk  '{print $2 }'`
echo $ms_flag
stream_no=`grep '       SPEC$STREAM' $mscard|awk  '{print $3 }'`
echo $stream_no
count=`grep '       SPEC$STREAM' $mscard|awk  '{print $3 }'`
if [ $ms_flag = "Y" ];then
   echo "RUNNING UTSRH1 IN MULTISTREAM MODE "
   export MULTISTREAM_UTSRH1="Y"
   echo > $sysout/$summary_file
   echo "STREAMS" $stream_no
   typeset -Z3 STR
   typeset -Z3 i
   STR=1
   i=1
   unsr=_
   while [ i -le $count ]
   do
        echo "Starting Stream :"  $i
        export stream=$program$unsr$i
        export outfile=$stream.$BANCS_HOSTNO.out
        $jobname$unsr$i$run_mode 2>&1 &
        sleep 2
        i=`expr $i + 1`
   done

   #All Streams have been submitted and monitor them
   echo
   while :
   do
   streams_running=`ps -fu $LOGNAME|grep 'rtsora UTSRH1'|grep -v grep|wc -l`
   if [ $streams_running -ne "0" ];then
      echo "RUNNING " $streams_running " STREAM(S) OF UTSRH1...."
      sleep 15
   else
      echo "COMPLETED depdsrh1ms.... SUMMARY IS AS FOLLOWS"
      break;
   fi
   done

   echo "STREAMS" $stream_ll the streams have completed processing, provide a summary
   echo "  STREAM NO    START TIME      END TIME     RETURN CODE "
   error=0
   for replica_name in `grep -e '... Start of  UTSRH1' $sysout/$summary_file|tr -s " "|cut -d' ' -f4`
   do
      stream_name=`grep -e '... Start of  '$replica_name $sysout/$summary_file \
                      |awk '{print $4}'`
      start_time=`grep -e '... Start of  '$replica_name $sysout/$summary_file \
                      |awk '{print $9}'`
      echo $replica_name|awk '{print $2}'
     #get end time of the replica
      end_stat=`grep -e '... End   of  '$stream_name $sysout/$summary_file \
                   |awk '{print $9,$15}'`
      end_time=`echo $end_stat|awk '{print $1}'`
      exit_cde=`echo $end_stat|awk '{print $2}'`
    #display statistics
      echo '  '$stream_name'      '$start_time'        '$end_time'        '$exit_cde
         if [ $exit_cde -ne "0" ];then
               error=$exit_cde
         fi
   done
else
   export MULTISTREAM_UTSRH1="N"
   echo "MULTI STREAM MODE NOT CHOSEN...."
   depdsrh1
fi
if [ "$error" -eq "0" ]; then
        if [ "$AUTOSYS_MODE" = "Y" ]; then
            echo "!!!depdsrh1 ran successfully!!!" >> $sysout/zerobyte.log
        else
            echo "!!!depdsrh1 ran successfully!!!"
        fi
else
        if [ "$AUTOSYS_MODE" = "Y" ]; then
                echo "!!!depdsrh1 failed!!!" >> $sysout/zerobyte.log
        else
                echo "!!!depdsrh1 failed!!!"
        fi
        exit 1
fi;



