<h3 class="box-title">Queue Buildup</h3>
<?php
    function safe_read($path) {
        return file_exists($path) ? trim(file_get_contents($path)) : '';
    }

    function safe_read_lines($path) {
        return file_exists($path) ? explode("\n", trim(file_get_contents($path))) : [];
    }

    $check_path = "/opt/hpws/apache/cgi-bin/trials/bip/data/TESTING/check_$crdate.txt";
    $start_time_path = "/opt/hpws/apache/cgi-bin/trials/bip/data/TESTING/start_time_$crdate.txt";
    $tpmtime = safe_read($check_path);
    $tpm_starttime = safe_read($start_time_path);
    $tpmtimestamp = shell_exec("ls -lrt $check_path | awk '{print $6,$7,$8}'");

    $checktpmrunning = safe_read("/opt/hpws/apache/cgi-bin/trials/bip/data/TESTING/tpmStatus.txt");
    $tpm_scp_time = shell_exec("cat /opt/hpws/apache/cgi-bin/trials/bip/data/TESTING/tpm_sequence_file_count.txt.$crdate | tail -1");
    $tpm_total_file = safe_read_lines("/opt/hpws/apache/cgi-bin/trials/bip/data/TESTING/tpm_sequence_file_count.txt.$crdate");

    $missingTPMSeq = [];
    $missing_count = 0;
    $tpm_button = "";

    foreach (array_filter($tpm_total_file) as $value) {
        $data = explode("|", trim($value));
        if (trim($data[0]) != '1') {
            $missing_count++;
            array_push($missingTPMSeq, $data);
        }
    }

    if ($missing_count > 0) {
        $tpm_button = "<button class='glow' data-toggle='modal' data-target='#tpm_modal' style='background-color:red;color:white'>TPM Alert</button>";
    }

    array_pop($missingTPMSeq);

    $tpm_running_from = '';
    if (stripos($checktpmrunning, 'terna') !== false) {
        $tpm_running_from = 'PR';
    } elseif (stripos($checktpmrunning, 'MIZO') !== false) {
        $tpm_running_from = 'NR';
    } elseif (stripos($checktpmrunning, 'ARASALAR') !== false) {
        $tpm_running_from = 'DR';
    }

    $tpm_scp_data = explode("|", $tpm_scp_time);
    $removeColon_tpm_scp_time = isset($tpm_scp_data[2]) ? strtotime(str_replace(":", "", trim($tpm_scp_data[2]))) : 0;

    $_tpmTime = $yummy->timeUpdatedTpm("tpmStatus.txt.", ".");
    $removeColonTPM = strtotime(str_replace(":", "", trim($_tpmTime)));
    $currtimes = strtotime(date("Ymd Hi"));
    $scp_difftimes = $currtimes - $removeColon_tpm_scp_time;
    $difftimes = $currtimes - $removeColonTPM;

    $FinalScpTime = "<span style='color:#fff'>" . (isset($tpm_scp_data[2]) ? trim($tpm_scp_data[2]) : "N/A") . "</span>";
    if ($scp_difftimes > 3600) {
        $FinalScpTime = "<span style='color:#fff'>" . (isset($tpm_scp_data[2]) ? trim($tpm_scp_data[2]) : "N/A") . "</span>";
    }

    $finalTpmTime = "<span style='color:#fff'>" . trim($_tpmTime) . "</span>";
    if ($difftimes > 600) {
        $finalTpmTime = "<span style='background-color:red;color:white' class='glow' title='TPM Not Updated since last 10 minutes'>" . trim($_tpmTime) . "</span>";
    }

    $TPM_start_time_hr = substr($tpm_starttime, 0, 2);
    $TPM_start_time_min = substr($tpm_starttime, 2, 2);
?>

<span style="float:left;font-size:14px;" class="btn btn-xs btn-success">
    <a class="btn btn-sm" style="float:left"
        onclick="window.open('TPMmonitorfile.php?date=<?php echo $crdate;?>','','height=900, width=1400,scrollbars=yes,resizable=yes' );">
        <?php
            echo "TPM Running on : $tpm_running_from | SFTP : $FinalScpTime | Tar Files : " . ($tpm_scp_data[0] ?? "N/A") . " $tpm_button";
        ?>
    </a>
</span>

<span class="queuetimepop" style="float:right;font-size:18px;"><img src="loading-bubbles.svg">
    <?php echo $yummy->timeUpdated("status_queue_8app.txt.false", ".");?>
</span>

<div class="box-tools pull-right"></div>

</div>
<div class="panel-body table-responsive hehe">
    <table class="table table-bordered table-striped text-center">
        <thead>
            <tr>
                <th>Queue Name</th>
                <?php for ($i = 0; $i <= 15; $i++): ?>
                    <th><?php echo $i == 0 ? "M" : "S$i"; ?></th>
                <?php endfor; ?>
            </tr>
        </thead>
        <tbody class="queueappend" style="font-size:15px;">
            <?php
                $buildup_flag = safe_read("/opt/hpws/apache/cgi-bin/trials/bip/data/TESTING/buildup_flag.txt");
                if ($buildup_flag == "0") {
                    $aplnMonior->status_queue();
                } else {
                    $aplnMonior->status_queue1();
                }
            ?>
        </tbody>
    </table>
</div>
